// Открытие смены ФР

// Параметры - 
// Заголовок строка, имя оператора открывающего смену
// FROperatorProfile число, профиль из карточки сотрудника
IF ( !ФР.МЕРКУРИЙФР_ОткрытьСессию( КОДОБОРУДОВАНИЯ, "Открытие смены" ) ) RETURN false;

//Проверим возраст буфера чеков
ФР.МЕРКУРИЙФР_ПроверкаВозрастаБуфера( );

//Получим номер ККТ
ДанныеОККТ = ФР.МЕРКУРИЙФР_ПолучениеИнформацииОККТ();	
IF ( !ПУСТО( ДанныеОККТ ) )
{
	ЗАГРУЗИТЬJSON( "ДанныеОтвета", ДанныеОККТ );
	
	ИнфоЗН = ЗНАЧЕНИЕПОЛЯ( "ДанныеОтвета", "kktNum" );
	
	IF ( !ПУСТО( ИнфоЗН ) )
	{
		ЗАПРОС("DELETE FROM param_ex WHERE param = 'FR_SERIAL" + КОДОБОРУДОВАНИЯ + "'");		
		ЗАПРОС("INSERT INTO param_ex (param, value) VALUES ('FR_SERIAL" + КОДОБОРУДОВАНИЯ + "', '" + ИнфоЗН + "')");
	}	
	
	УДАЛИТЬКОНТЕКСТ( "ДанныеОтвета" );
}
		
// Проверка статуса смены
ОтветСостояниеККТ = ФР.МЕРКУРИЙФР_ПолучениеСостоянияККТ();
		
IF ( !ПУСТО( ОтветСостояниеККТ ) )
{
	СменаОткрыта	= ПОЛЕ_JSON( ПОЛЕ_JSON( ОтветСостояниеККТ, "shiftInfo", "" ), "isOpen", "" ) == "true";
	/*
	СменаПревысила24Часа	= ПОЛЕ_JSON( ПОЛЕ_JSON( ОтветСостояниеККТ, "shiftInfo", "" ), "is24Expired", "" );
	IF ( СменаПревысила24Часа )
	{
		СООБЩЕНИЕ("ККМ """ + ФР.ИМЯОБОРУДОВАНИЯ() + """: Смена превысила 24 часа." + CHR( 13 ) + "Необходимо произвести закрытие смены.");
	}
	*/
	
	IF ( СменаОткрыта == true OR СменаОткрыта == "true" )
	{
		СООБЩЕНИЕ("Смена открыта в ККМ", ФР.ИМЯОБОРУДОВАНИЯ() );
		RETURN true;
	}
	ELSE
	{
		//теперь открываем смену
		ТекстВопроса 			= "В ККМ """ + ФР.ИМЯОБОРУДОВАНИЯ() + """ не открыта смена." + CHR( 13 ) + "Произвести открытие смены в ККМ?";
		КодОтвета 				= СООБЩЕНИЕ( ТекстВопроса, "Открытие смены", 4 );
		IF ( КодОтвета == 7 ) //если нажали "Нет"
		{
			ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "Открытие смены" );
			RETURN false;
		}
	}
}

//открываем смену
_ИМЯКАССИРА		= "";
_ИННКАССИРА		= "";
IF ( !ФР.МЕРКУРИЙФР_ПолучитьДанныеКассира(froperator, @_ИМЯКАССИРА, @_ИННКАССИРА) )
	_ИМЯКАССИРА = "Кассир";

//sessionKey = ДАННЫЕ_JSON("sessionKey", ALLTRIM( _МАССИВКЛЮЧЕЙФР[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ]  ) );
Команда = ДАННЫЕ_JSON("command", "OpenShift");
ПечататьДокумент = ДАННЫЕ_JSON("printDoc", true);
КассирИмя = ДАННЫЕ_JSON("cashierName", _ИМЯКАССИРА);
КассирИНН = ДАННЫЕ_JSON("cashierINN", _ИННКАССИРА);


ТекстЗапросаОткрытиеСмены = "{ ""sessionKey"": """ + _МАССИВКЛЮЧЕЙФР[ VAL( ФР.КОДОБОРУДОВАНИЯ() ) ] + """, " + Команда + ", ""cashierInfo"": { " + КассирИмя + ", " + КассирИНН + " } }";


ОТВЕТ = "";

IF ( !ФР.МЕРКУРИЙФР_HTTPPOST(ФР.МЕРКУРИЙФР_АДРЕССЕРВЕРА(), "/api.json", ТекстЗапросаОткрытиеСмены, "", @ОТВЕТ) )
	RETURN false;

RETURN ФР.МЕРКУРИЙФР_ЗакрытьСессию( КОДОБОРУДОВАНИЯ, "Открытие смены" );
