
// Функция разбора XML файла с КУПД
Имя								= UPPER( ALLTRIM( Имя ) );
IF ( ТипТэга == "ТЭГ" AND !ФлагЗакрытия )
{
	
	IF ( Имя == "СВУЧДОКОБОР" )
	{
		Состояние				= "СвУчДокОбор";
		ТекущийОбъект			= "";
		ПродавецЭДОИД			= "";
		ПолучательЭДОИД			= "";
	}
	ELSE IF ( Имя == "СВКСЧФ" )
	{
		Состояние				= "СвСчФакт";
		ТекущийОбъект			= "";
		Номер 					= "";
		Дата 					= {};
		ПродавецНаименование 	= "";
		ПродавецИНН 			= "";
		ПродавецКПП 			= "";
		ПродавецАдрес 			= "";
		ПродавецСчет 			= "";
		ПродавецБанк 			= "";
		Грузополучатель			= "";
		ГрузополучательКПП		= "";
		ПолучательНаименование 	= "";
		ПолучательИНН 			= "";
		ПолучательКПП 			= "";
		Сумма 					= 0.00;
		СуммаБезНДС				= 0.00;
	}
	ELSE IF ( Имя == "СВПРОД" )
	{
		Состояние				= "СвПрод";
		ТекущийОбъект			= "Продавец";
	}
	ELSE IF ( Имя == "СВПОКУП" )
	{
		Состояние				= "СвПокуп";
		ТекущийОбъект			= "Покупатель";
	}
	ELSE IF ( Имя == "ГРУЗПОЛУЧ" )
	{
		Состояние				= "ГрузПолуч";
		ТекущийОбъект			= "Грузополучатель";
	}
	ELSE IF ( Имя == "ИДСВ" )
		Состояние				= "ИдСв";
	ELSE IF ( Имя == "АДРЕС" )
		Состояние				= "Адрес";
	ELSE IF ( Имя == "БАНКРЕКВ" )
		Состояние				= "БАНКРЕКВ";
	ELSE IF ( Имя == "СВЕДТОВ" )
	{
		НаименованиеТовара		= "";

		НомерСтрокиДо 			= 0;
		ЕдиницаДо 				= "";
		ОКЕИДо 					= "";
		НалогДо					= 0.00;
		КоличествоДо			= 0.00;
		СуммаДо					= 0.00;
		СуммаБезНДСДо			= 0.00;
		ШтрихКодДо 				= "";

		НомерСтрокиПосле		= 0;
		ЕдиницаПосле			= "";
		ОКЕИПосле				= "";
		НалогПосле				= 0.00;
		КоличествоПосле			= 0.00;
		СуммаПосле				= 0.00;
		СуммаБезНДСПосле		= 0.00;
		ШтрихКодПосле			= "";

		Состояние				= "";
		ТекущийОбъект			= "Товар";
	}
	ELSE IF ( Имя == "ИНФПОЛФХЖ2" )
		Состояние				= "ИНФПОЛФХЖ2";
	ELSE IF ( ИМЯ == "НОМСРЕДИДЕНТТОВДО" ) 
		Состояние 				= "НомСредИдентТовДо";
	ELSE IF ( ИМЯ == "НОМСРЕДИДЕНТТОВПОСЛЕ" ) 
		Состояние 				= "НомСредИдентТовПосле";
	ELSE IF ( ИМЯ == "СТТОВБЕЗНДС" ) 
		Состояние 				= "СтТовБезНДС";
	ELSE IF ( ИМЯ == "СТТОВУЧНАЛ" ) 
		Состояние 				= "СтТовУчНал";
}
IF ( ТипТэга == "ТЭГ" AND ФлагЗакрытия )
{
	IF ( Имя == "ДОКУМЕНТ" )
	{
		ДОБАВИТЬСТРОКИ( 1, "Документ" );
		ИЗМЕНИТЬПОЛЕ( "Документ", "Номер", Номер );
		ИЗМЕНИТЬПОЛЕ( "Документ", "Дата", Дата );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПродавецНаименование", ПродавецНаименование );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПродавецИНН", ПродавецИНН );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПродавецКПП", ПродавецКПП );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПродавецАдрес", ПродавецАдрес );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПродавецСчет", ПродавецСчет );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПродавецБанк", ПродавецБанк );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПродавецЭДОИД", ПродавецЭДОИД );
		ИЗМЕНИТЬПОЛЕ( "Документ", "Грузополучатель", Грузополучатель );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ГрузополучательКПП", ГрузополучательКПП );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПолучательНаименование", ПолучательНаименование );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПолучательИНН", ПолучательИНН );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПолучательКПП", ПолучательКПП );
		ИЗМЕНИТЬПОЛЕ( "Документ", "ПолучательЭДОИД", ПолучательЭДОИД );
		ИЗМЕНИТЬПОЛЕ( "Документ", "Сумма", Сумма );
		ИЗМЕНИТЬПОЛЕ( "Документ", "СуммаБезНДС", СуммаБезНДС );
		
		Состояние				= "";
		ТекущийОбъект			= "";
	}
	ELSE IF ( Имя == "СВПРОД" )
	{
		Состояние				= "";
		ТекущийОбъект			= "";
	}
	ELSE IF ( Имя == "СВПОКУП" )
	{
		Состояние				= "";
		ТекущийОбъект			= "";
	}
	ELSE IF ( Имя == "СВЕДТОВ" )
	{
		ДОБАВИТЬСТРОКИ( 1, "СтрокиДокумента" );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "НомерСтроки", НомерСтрокиДо );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "НаименованиеТовара", НаименованиеТовара );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Единица", ЕдиницаДо );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "ОКЕИ", ОКЕИДо );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Количество", -КоличествоДо );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Сумма", -СуммаДо );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "СуммаБезНДС", -СуммаБезНДСДо );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "ШтрихКод", ШтрихКод );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Налог", НалогДо );

		ДОБАВИТЬСТРОКИ( 1, "СтрокиДокумента" );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "НомерСтроки", НомерСтрокиПосле );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "НаименованиеТовара", НаименованиеТовара );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Единица", ЕдиницаПосле );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "ОКЕИ", ОКЕИПосле );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Количество", КоличествоПосле );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Сумма", СуммаПосле );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "СуммаБезНДС", СуммаБезНДСПосле );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "ШтрихКод", ШтрихКод );
		ИЗМЕНИТЬПОЛЕ( "СтрокиДокумента", "Налог", НалогПосле );

		Состояние				= "";
		ТекущийОбъект			= "";
	}
	ELSE IF ( ВСПИСКЕ( Имя, "КИЗ", "ИДЕНТТРАНСУПАК", "НОМУПАК" ) )
	{
		ДОБАВИТЬСТРОКИ( 1, "Марки" );
		ИЗМЕНИТЬПОЛЕ( "Марки", "НомерСтроки", ЕСЛИ( Состояние == "НомСредИдентТовДо", НомерСтрокиДо, НомерСтрокиПосле ) );
		ИЗМЕНИТЬПОЛЕ( "Марки", "Марка", Сервис.КИЗИзЗначения( Значение ) );
	}
	ELSE IF ( Имя == "ИНФПОЛФХЖ2" )
		Состояние				= "";
}
ELSE IF ( ТипТэга == "АТРИБУТ" )
{
	IF ( Имя == "ИДОТПР" AND Состояние == "СвУчДокОбор" )
		ПродавецЭДОИД			= Значение;
	ELSE IF ( Имя == "ИДПОЛ" AND Состояние == "СвУчДокОбор" )
		ПолучательЭДОИД			= Значение;
	ELSE IF ( Имя == "НОМЕРСЧФ" )
		Номер					= Значение;
	ELSE IF ( Имя == "ДАТАСЧФ" )
		Дата					= CTOD( Значение );
	ELSE IF ( Имя == "НАИМОРГ" )
	{
		IF ( ТекущийОбъект == "Продавец" ) 
			ПродавецНаименование	= Значение;
		ELSE IF ( ТекущийОбъект == "Покупатель" ) 
			ПолучательНаименование	= Значение;
	}
	ELSE IF ( ВСПИСКЕ( Имя, "ФАМИЛИЯ", "ИМЯ", "ОТЧЕСТВО" ) )
	{
		IF ( ТекущийОбъект == "Продавец" ) 
			ПродавецНаименование	+= ЕСЛИ( !ПУСТО( ПродавецНаименование ), " ", "" ) + Значение;
		ELSE IF ( ТекущийОбъект == "Покупатель" ) 
			ПолучательНаименование	+= ЕСЛИ( !ПУСТО( ПолучательНаименование ), " ", "" ) + Значение;
	}
	ELSE IF ( ВСПИСКЕ( Имя, "ИННЮЛ", "ИННФЛ" ) )
	{
		IF ( ТекущийОбъект == "Продавец" ) 
			ПродавецИНН				= Значение;
		ELSE IF ( ТекущийОбъект == "Покупатель" ) 
			ПолучательИНН			= Значение;
	}
	ELSE IF ( Имя == "КПП" )
	{
		IF ( ТекущийОбъект == "Продавец" ) 
			ПродавецКПП				= Значение;
		ELSE IF ( ТекущийОбъект == "Покупатель" ) 
			ПолучательКПП			= Значение;
		ELSE IF ( ТекущийОбъект == "Грузополучатель" ) 
			ГрузополучательКПП		= Значение;
	}
	ELSE IF ( ВСПИСКЕ( Имя, "ИНДЕКС", "КОДРЕГИОН", "РАЙОН", "ГОРОД", "НАСЕЛЕННЫЙПУНКТ", "УЛИЦА", "ДОМ", "КОРПУС", "КВАРТИРА" ) )
	{
		IF ( ТекущийОбъект == "Продавец" ) 
			ПродавецАдрес			+= ЕСЛИ( !ПУСТО( ПродавецАдрес ), ",", "" )	+ Значение;
		IF ( ТекущийОбъект == "Грузополучатель" ) 
			Грузополучатель			+= ЕСЛИ( !ПУСТО( Грузополучатель ), ",", "" )	+ Значение;
	}
	ELSE IF ( Имя ==  "НОМЕРСЧЕТА" AND ТекущийОбъект == "Продавец" )
		ПродавецСчет				= Значение;
	ELSE IF ( Имя ==  "БИК" AND ТекущийОбъект == "Продавец" )
		ПродавецБанк				= Значение;
	ELSE IF ( Имя ==  "СТОИМДОИЗМ" && Состояние == "СтТовУчНал" )
		СуммаДо						= VAL( Значение );
	ELSE IF ( Имя ==  "СТОИМПОСЛЕИЗМ" && Состояние == "СтТовУчНал" )
		СуммаПосле					= VAL( Значение );
	ELSE IF ( Имя ==  "СТОИМДОИЗМ" && Состояние == "СтТовБезНДС" )
		СуммаБезНДСДо				= VAL( Значение );
	ELSE IF ( Имя ==  "СТОИМПОСЛЕИЗМ" && Состояние == "СтТовБезНДС" )
		СуммаБезНДСПосле			= VAL( Значение );
	ELSE IF ( Имя ==  "СТТОВБЕЗНДСВСЕГО" )
		СуммаБезНДС					= VAL( Значение );
	ELSE IF ( Имя ==  "СТТОВУЧНАЛВСЕГО" )
		Сумма						= VAL( Значение );
	ELSE IF ( Имя ==  "НОМСТР" AND ТекущийОбъект == "Товар" )
	{
		НомерСтрокиДо				= 2 * VAL( Значение ) - 1;
		НомерСтрокиПосле			= НомерСтрокиДо + 1;
	}
	ELSE IF ( Имя ==  "НАИМТОВ" AND ТекущийОбъект == "Товар" )
		НаименованиеТовара			= Значение;
	ELSE IF ( Имя ==  "ОКЕИ_ТОВДО" AND ТекущийОбъект == "Товар" )
		ОКЕИДо						= Значение;
	ELSE IF ( Имя ==  "ОКЕИ_ТОВПОСЛЕ" AND ТекущийОбъект == "Товар" )
		ОКЕИПосле					= Значение;
	ELSE IF ( Имя ==  "НАЛСТДО" AND ТекущийОбъект == "Товар" )
		НалогДо						= VAL( Значение );
	ELSE IF ( Имя ==  "НАЛСТПОСЛЕ" AND ТекущийОбъект == "Товар" )
		НалогПосле					= VAL( Значение );
	ELSE IF ( Имя ==  "КОЛТОВДО" AND ТекущийОбъект == "Товар" )
		КоличествоДо				= VAL( Значение );
	ELSE IF ( Имя ==  "КОЛТОВПОСЛЕ" AND ТекущийОбъект == "Товар" )
		КоличествоПосле				= VAL( Значение );
	ELSE IF ( Имя ==  "СТТОВУЧНАЛ" AND ТекущийОбъект == "Товар" )
		Сумма	 					= VAL( Значение );
	ELSE IF ( Имя ==  "СТТОВБЕЗНДС" AND ТекущийОбъект == "Товар" )
		СуммаБезНДС					= VAL( Значение );
	ELSE IF ( Имя ==  "НАИМЕДИЗМДО" AND ТекущийОбъект == "Товар" )
		ЕдиницаДо 					= Значение;
	ELSE IF ( Имя ==  "НАИМЕДИЗМПОСЛЕ" AND ТекущийОбъект == "Товар" )
		ЕдиницаПосле				= Значение;
	ELSE IF ( Имя ==  "ИДЕНТИФ" AND ТекущийОбъект == "Товар" AND Состояние == "ИНФПОЛФХЖ2" AND UPPER( ALLTRIM( Значение ) ) == "ШТРИХКОД" )
		Состояние 					= "ШТРИХКОД";
	ELSE IF ( Имя ==  "ЗНАЧЕН" AND ТекущийОбъект == "Товар" AND Состояние == "ШТРИХКОД" )
		ШтрихКод 					= Значение;
	ELSE IF ( ВСПИСКЕ( Имя, "КИЗ", "ИДЕНТТРАНСУПАК", "НОМУПАК" ) )
	{
		ДОБАВИТЬСТРОКИ( 1, "Марки" );
		ИЗМЕНИТЬПОЛЕ( "Марки", "НомерСтроки", ЕСЛИ( Состояние == "НомСредИдентТовДо", НомерСтрокиДо, НомерСтрокиПосле ) );
		ИЗМЕНИТЬПОЛЕ( "Марки", "Марка", Сервис.КИЗИзЗначения( Значение ) );
	}
}
