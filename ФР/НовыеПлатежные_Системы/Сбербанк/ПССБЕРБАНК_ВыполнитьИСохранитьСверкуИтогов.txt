// Закрытие банковского дня при наличии безналичных платежей

ТекстЧека = "";
ЗаголовокЧека = "";
ПозицииЧека = "";

try
{
	DriverPayCard = CreateObject( "SBRFSRV.Server", 1 );
}
catch()
{
	DriverPayCard = false;
}
IF ( TYPE("DriverPayCard") <> "O")
{
	Сообщение("Не удалось создать объект драйвера платежных систем." + CHR(13) + "Проверьте корректность установки компонент Сбербанка.", ФР.ПСИМЯОБОРУДОВАНИЯ());
	RETURN false;
}

//сверка итогов
DriverPayCard.Clear();
НомерОперации = 6000;
ОтветПС = DriverPayCard.NFun(НомерОперации);
IF ( ОтветПС <> 0 )
{
	СООБЩЕНИЕ( "Ошибка платежной системы: " + ОтветПС + "." + CHR(13) + CHR(10) +
	ФР.ПССБЕРБАНК_ПолучитьОписаниеОшибки( ОтветПС ), ФР.ПСИМЯОБОРУДОВАНИЯ() );
	RETURN false;
}
ELSE
{	
	/*
	НОМЕРУСТРОЙСТВАДЛЯПС		= ЗАПРОС( "SELECT code FROM sprequipment WHERE f_paysystem = 1" );
	ИНДЕКСУСТРОЙСВАПЕЧАТИ		= ЕСЛИ(!ПУСТО(НОМЕРУСТРОЙСТВАДЛЯПС), НОМЕРУСТРОЙСТВАДЛЯПС, КОДОБОРУДОВАНИЯ);
	*/
	
	
	КоличествоПустыхСтрок = 0;
	//получаем слип-чек и добавляем в чек
	СлипЧек = DriverPayCard.GParamString("Cheque");	
	ТипТранзакции = 10;
	try
	{
		ЗАПРОС( "INSERT INTO paycardtrans ( equipment, TransType, operationtype, transdate, slip, fr_code )
			 VALUES ( '"	+ КОДОБОРУДОВАНИЯ + "', '" 
							+ ТипТранзакции + "', "
							+ НомерОперации + ", '"
							+ ДАТА() + "', '"
							+ STDF( СлипЧек ) + "', '"
							+ ФРКОДОБОРУДОВАНИЯ + 
							"' )" );
	}
	catch()
	{
		СООБЩЕНИЕ("Ошибка записи данных сверки итогов в базу", ФР.ПСИМЯОБОРУДОВАНИЯ());
	}
	
	//печатаем сверку
	IF ( Сервис.РМККоманда( "ОБОРУДОВАНИЕ", "ФР" ) )
	{
		IF ( ATC(_ОБОРУДОВАНИЕ, ФРКОДОБОРУДОВАНИЯ ) > 0 )
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ФРКОДОБОРУДОВАНИЯ;
		ELSE
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ЛЕВСИМВ( _ОБОРУДОВАНИЕ, 3 );
		
		ТипОтчета = -1;
		КОЛИЧЕСТВОСЛИПОВ = 1;
		Сервис.РМККоманда( "ВЫПОЛНИТЬКОМАНДУПРОФИЛЯ", КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ + "|116|ЭтоБанковскийСлип=true" );
	}
	
}
DriverPayCard.Clear();
DriverPayCard = false;

RETURN true;
