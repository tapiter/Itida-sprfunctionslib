// Закрытие чека

// Параметры - 
// СуммаОплаты число вещественное, сумма, полученная от покупателя
// ПроцентСкидки число вещественное, процент скидки на чек
// Параметр - FROperatorProfile число, профиль из карточки сотрудника

ЭТОРМК = false;			
IF (TYPE("_МРП") <> "U")
	ЭТОРМК = _МРП == "2";
IF (ЭТОРМК)
{
	//печать комментария после фискальных строк и перед оплатой
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, mode, checktype, name)
			 VALUES ( 'Печать строки', 2, 'left', '" + STDF(КОММЕНТАРИЙ) + "' )" );
} 

IF ( ПЕРЕМЕННАЯ( "ЭтоТоварныйЧек", false ) == true )
{
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation,price)
			 VALUES ( 'ИТОГ', " + STR( СУММАОПЛАТЫ, 16, 2 ) + " )" );
}

//Если тип чека "Прочее/Вскрытие тары", то добавляем только печать нефискальных строк с оплатой
IF ( ТипЧека == 6 ) 
{
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, password, mode, checktype, 
														name, quantity, price, destination)
			 VALUES ( 'Печать строки', '', 0, 0, '================================================', 0, 0, 0 )" );	
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, password, mode, checktype, 
														name, quantity, price, destination)
			 VALUES ( 'Печать строки', '', 1, 0, 'ИТОГ: " + STR( СуммаЧека, 16, 2 ) + "', 0, 0, 0 )" );
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation,checktype)
			 VALUES ( 'Закрытие чека', 0 )" );	
}
ELSE
{
	//безнал
	IF ( ROUND( СуммаБезнал, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ФР.ККТ_ПолучитьКодОплатыПоТипуОплаты( 1, МОДЕЛЬОБОРУДОВАНИЯ ) + "', " + STR( СуммаБезнал, 16, 2 ) + " )" );
				
	//сертификат			
	IF ( ROUND( СУММАСЕРТИФИКАТ, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ФР.ККТ_ПолучитьКодОплатыПоТипуОплаты( 2, МОДЕЛЬОБОРУДОВАНИЯ ) + "', " + STR( СУММАСЕРТИФИКАТ, 16, 2 ) + " )" );
	
	//аванс от покупателя
	IF ( ЭТОРМК )
	{
		IF ( ROUND( СУММААВАНСА, 2 ) != 0 )
			ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
					VALUES ( 'Оплата', '" + ФР.ККТ_ПолучитьКодОплатыПоТипуОплаты( 2, МОДЕЛЬОБОРУДОВАНИЯ ) + "', " + STR( СУММААВАНСА, 16, 2 ) + " )" );
					
		//СУММАПРЕДОПЛАТЫПОСТАВЩИКУ
		IF ( ROUND( СУММАПРЕДОПЛАТЫПОСТАВЩИКУ, 2 ) != 0 )
			ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
					VALUES ( 'Оплата', '" + ФР.ККТ_ПолучитьКодОплатыПоТипуОплаты( 2, МОДЕЛЬОБОРУДОВАНИЯ ) + "', " + STR( СУММАПРЕДОПЛАТЫПОСТАВЩИКУ, 16, 2 ) + " )" );
	}	
	
	//кредит
	IF ( ROUND( СУММАКРЕДИТ, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ФР.ККТ_ПолучитьКодОплатыПоТипуОплаты( 3, МОДЕЛЬОБОРУДОВАНИЯ ) + "', " + STR( СУММАКРЕДИТ, 16, 2 ) + " )" );
		
	//встречное предоставление (только в МРП)	
	IF ( !ЭТОРМК )
	{
		IF ( ROUND( ВСЕГОПРОЧАЯОПЛАТА, 2 ) != 0 )
			ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
					VALUES ( 'Оплата', '" + ФР.ККТ_ПолучитьКодОплатыПоТипуОплаты( 4, МОДЕЛЬОБОРУДОВАНИЯ ) + "', " + STR( ВСЕГОПРОЧАЯОПЛАТА, 16, 2 ) + " )" );
	}
	
	//наличные
	IF ( ROUND( СуммаНал, 2 ) != 0 )
		ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, closetype, price )
				VALUES ( 'Оплата', '" + ФР.ККТ_ПолучитьКодОплатыПоТипуОплаты( 0, МОДЕЛЬОБОРУДОВАНИЯ ) + "', " + STR( СуммаНал + СДАЧА, 16, 2 ) + " )" );
				
	ЗАПРОС( "INSERT INTO " + ИмяТаблицыСтрокЧека + " ( operation, price )
			VALUES ( 'Закрытие чека', " + STR( 0, 16, 2 ) + " )" );
}

РезультатФЛК = ФР.ПроизвестиФорматноЛогическийКонтроль();

IF ( TYPE("ВерсияФФД") == "U" )	
	ВерсияФФД = "1.05";

//для ФФД 1.2 проверим позиции предварительно через ФР
IF ( ALLTRIM(ПЕРЕМЕННАЯ("ВерсияФФД", "1.05")) == "1.2" И ВСПИСКЕ(МОДЕЛЬОБОРУДОВАНИЯ, "АТОЛДТО10") )
{
	IF ( ФР.ЕстьПозицииСМаркировкойВЧеке() )
	{
		IF (МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10")
		{
			//если нет контекста с результатами проверки КМ, то запускаем проверку всех КМ в чеке при закрытии чека
			IF ( !ВЫБРАТЬКОНТЕКСТ( "РезультатыОбработкиКМ" ) )
			{
				ФР.АТОЛДТО10_ОчиститьТаблицуПроверенныхКМ( ФР.КОДОБОРУДОВАНИЯ() );
				IF ( !ФР.АТОЛДТО10_ПроверитьКМВПозицияхЧекаАвтоматически( ФР.КОДОБОРУДОВАНИЯ() ) )
				{
					_ERROR = true;
					RETURN false;
				}
			}
		}
	}
}

БанковскиеПозицииЧека = "";
IF ( !ПУСТО( ИМЯПЛАТЕЖНОЙСИСТЕМЫ ) AND МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" AND !ПЕРЕМЕННАЯ("Доставка", false) )
{
	IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "ПСАТОЛ")
	{
		IF ( !ФР.ПСАТОЛ_ПровестиОперациюОплаты( ФР.КОДОБОРУДОВАНИЯ(), МОДЕЛЬОБОРУДОВАНИЯ ) )
		{
			_ERROR = true;
			RETURN false;
		}
	}
	ELSE IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "СБЕРБАНК")
	{
		IF ( !ФР.ПССБЕРБАНК_ПровестиОперациюОплаты( ФР.КОДОБОРУДОВАНИЯ(), МОДЕЛЬОБОРУДОВАНИЯ ) )
		{
			_ERROR = true;
			RETURN false;
		}
	}
}

/*
//новые платежные системы
ФР.ККТ_СформироватьИНапечататьСлип( МОДЕЛЬОБОРУДОВАНИЯ );
*/

//печать чека
IF ( МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" )
{
	IF ( ПЕРЕМЕННАЯ( "ЭтоТоварныйЧек", false ) )
		РезультатПечатиЧека		= ФР.АТОЛДТО10_ПечатьНефискальногоЧекаНаФР( );
	ELSE
		РезультатПечатиЧека		= ФР.АтолДТО10_ПечатьЧекаНаФР( );
}
ELSE IF ( МОДЕЛЬОБОРУДОВАНИЯ == "МЕРКУРИЙ" )
	РезультатПечатиЧека		= ФР.МЕРКУРИЙФР_ПечатьЧекаНаФР( );
ELSE IF ( МОДЕЛЬОБОРУДОВАНИЯ == "ШТРИХ" )
	РезультатПечатиЧека		= ФР.ШТРИХ_ПечатьЧекаНаФР( );
ELSE
	РезультатПечатиЧека		= false;
	
Результат 				= РезультатПечатиЧека == true;

IF ( !ПУСТО( ИМЯПЛАТЕЖНОЙСИСТЕМЫ ) AND МОДЕЛЬОБОРУДОВАНИЯ == "АТОЛДТО10" AND !ПЕРЕМЕННАЯ("Доставка", false) )
{
	IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "ПСАТОЛ")
		ФР.ПСАТОЛ_ЗавершениеОперацииОплаты( Результат );
	IF ( UPPER(ИМЯПЛАТЕЖНОЙСИСТЕМЫ) == "СБЕРБАНК")
		ФР.ПССБЕРБАНК_ЗавершениеОперацииОплаты( Результат );
}

НомерЧекаККМ 			= 0;
НомерСменыККМ 			= 0;

IF (Результат == false)
	_ERROR = true;

RETURN Результат;
