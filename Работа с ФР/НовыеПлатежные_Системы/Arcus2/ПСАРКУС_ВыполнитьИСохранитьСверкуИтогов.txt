// Закрытие банковского дня при наличии безналичных платежей

ТекстЧека = "";
ЗаголовокЧека = "";
ПозицииЧека = "";

IF ( !ФР.ПСАРКУС_Установлен() ) RETURN false;

//печать полного журнала
КодОперацииАркус = 7;
IF ( !ФР.ПСАРКУС_ВыполнитьКоманду(КодОперацииАркус, "", "", "" ) ) RETURN false;

ОтветПС = ФР.ПСАРКУС_ПрочитатьОтветПС();
IF ( ОтветПС <> "000" )
{
	СООБЩЕНИЕ( "Ошибка платежной системы: " + ОтветПС + "." + CHR(13) + CHR(10) +
	ФР.ПСАРКУС_ПолучитьСлип( ), ФР.ПСИМЯОБОРУДОВАНИЯ() );
	RETURN false;
}
ELSE
{	
	КоличествоПустыхСтрок = 0;
	//получаем слип-чек и добавляем в чек
	СлипЧек = ФР.ПСАРКУС_ПолучитьСлип();	
	//печатаем сверку
	IF ( Сервис.РМККоманда( "ОБОРУДОВАНИЕ", "ФР" ) )
	{
		IF ( ATC(_ОБОРУДОВАНИЕ, ФРКОДОБОРУДОВАНИЯ ) > 0 )
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ФРКОДОБОРУДОВАНИЯ;
		ELSE
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ЛЕВСИМВ( _ОБОРУДОВАНИЕ, 3 );
		
		ТипОтчета = -1;
		КОЛИЧЕСТВОСЛИПОВ = 1;
		Сервис.РМККоманда( "ВЫПОЛНИТЬКОМАНДУПРОФИЛЯ", КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ + "|116|ЭтоБанковскийСлип=true" );
	}	
}

//сверка итогов
КодОперацииАркус = 10;
IF ( !ФР.ПСАРКУС_ВыполнитьКоманду(КодОперацииАркус, "", "", "" ) ) RETURN false;

ОтветПС = ФР.ПСАРКУС_ПрочитатьОтветПС();
IF ( ОтветПС <> "000" )
{
	СООБЩЕНИЕ( "Ошибка платежной системы: " + ОтветПС + "." + CHR(13) + CHR(10) +
	ФР.ПСАРКУС_ПолучитьСлип( ), ФР.ПСИМЯОБОРУДОВАНИЯ() );
	RETURN false;
}
ELSE
{	
	
	КоличествоПустыхСтрок = 0;
	//получаем слип-чек и добавляем в чек
	СлипЧек = ФР.ПСАРКУС_ПолучитьСлип();
	ТипТранзакции = 10;
	try
	{
		ЗАПРОС( "INSERT INTO paycardtrans ( equipment, TransType, operationtype, transdate, slip, fr_code )
			 VALUES ( '"	+ КОДОБОРУДОВАНИЯ + "', '" 
							+ ТипТранзакции + "', "
							+ КодОперацииАркус + ", '"
							+ ДАТА() + "', '"
							+ STDF( СлипЧек ) + "', '"
							+ ФРКОДОБОРУДОВАНИЯ + 
							"' )" );
	}
	catch()
	{
		СООБЩЕНИЕ("Ошибка записи данных сверки итогов в базу", ФР.ПСИМЯОБОРУДОВАНИЯ());
	}
	
	//печатаем сверку
	IF ( Сервис.РМККоманда( "ОБОРУДОВАНИЕ", "ФР" ) )
	{
		IF ( ATC(_ОБОРУДОВАНИЕ, ФРКОДОБОРУДОВАНИЯ ) > 0 )
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ФРКОДОБОРУДОВАНИЯ;
		ELSE
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ЛЕВСИМВ( _ОБОРУДОВАНИЕ, 3 );
		
		ТипОтчета = -1;
		КОЛИЧЕСТВОСЛИПОВ = 1;
		РезультатПечатиСлипа = Сервис.РМККоманда( "ВЫПОЛНИТЬКОМАНДУПРОФИЛЯ", КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ + "|116|ЭтоБанковскийСлип=true" );
	}
	
}

RETURN true;
