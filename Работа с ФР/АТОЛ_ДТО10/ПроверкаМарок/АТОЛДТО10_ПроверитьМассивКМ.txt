НЕКОРРЕКТНЫЕКМ = "";

IF ( ПУСТО(СПИСОККМ) )
	RETURN false;
	
//подключаемся к ККТ
IF ( !ФР.АТОЛДТО10_ОткрытьФР( КОДОБОРУДОВАНИЯ, "Проверка массива КМ" ) ) RETURN false;

ТипЗадания		= ДАННЫЕ_JSON("type", "validateMarks");
Таймаут			= ДАННЫЕ_JSON("timeout", 5000); //5 секунд

//массив самих КМ в формате JSON
КоличествоКМ	= 0;
МассивКМ[]		= "";
JSONПроверяемыеКМ	= "";

СПИСОККМ	= "|" + СПИСОККМ;
НомерСлова	= 1;
КодМаркировки = ПОЛУЧИТЬСЛОВО( СПИСОККМ, "|", НомерСлова);
WHILE ( !ПУСТО(КодМаркировки) )
{
	МассивКМ[ НомерСлова ] = КодМаркировки;
	КоличествоКМ++;
	НомерСлова++;
	КодМаркировки = ПОЛУЧИТЬСЛОВО( СПИСОККМ, "|", НомерСлова);
}
JSONПроверяемыеКМ += "[";
НомерКМПП = 1;
WHILE ( НомерКМПП <= КоличествоКМ )
{
	ДанныеМарки = МассивКМ[ НомерКМПП ];
	
	ТэгТипКодаМаркировки = ДАННЫЕ_JSON("imcType", "auto"); //определить тип КМ автоматически;
	ТэгКодМаркировки = ДАННЫЕ_JSON("imc", ПЕРЕКОДИРОВАТЬ(ДанныеМарки,,"BASE64")); //base64-представление значения кода маркировки (тег 2000)
	ТэгПланируемыйСтатус = ДАННЫЕ_JSON("itemEstimatedStatus", ЕСЛИ( ИмяОперации == "Регистрация", "itemPieceSold", "itemPieceReturn")); //1 - itemPieceSold - штучный товар, реализован;
																				//2 - itemDryForSale - мерный товар, в стадии реализации;
																				//3 - itemPieceReturn - штучный товар, возвращен;
																				//4 - itemDryReturn - часть товара, возвращена;
																				//255 - itemStatusUnchanged - статус товара, не изменился;
	ТэгРежимОбработкиКМ = ДАННЫЕ_JSON("imcModeProcessing", 0); //Режим обработки кода товара (тег 2102)
	//ТэгДробноеКоличествоТовара = ДАННЫЕ_JSON("itemFractionalAmount", "1/5"); //Дробное количество маркированного товара (тег 1291). Используется только для КМ в позициях без проверки в чеке
	ТэгКоличествоТовара = ДАННЫЕ_JSON("itemQuantity", 1); //Количество товара (тег 1023)
	ТэгМераТовара = ДАННЫЕ_JSON("itemUnits", "piece"); //Мера количества товара (тег 2108). Используется только для проверки КМ
	
	JSONПроверяемыеКМ += ЕСЛИ( ПРАВСИМВ( JSONПроверяемыеКМ, 1 ) == "}", ",", "") + "{" + ТэгТипКодаМаркировки + "," + ТэгКодМаркировки + "," + ТэгПланируемыйСтатус + "," + ТэгРежимОбработкиКМ + "," + ТэгКоличествоТовара + "," + ТэгМераТовара + "}";
	НомерКМПП++;
}
JSONПроверяемыеКМ += "]";


//формируем задание
ТекстЗадания = "{" + ТипЗадания + "," + Таймаут + "," + """params"":" + JSONПроверяемыеКМ + "}";


fptr.setParam( fptr.LIBFPTR_PARAM_JSON_DATA, ТекстЗадания );
fptr.processJson( );

//ОБРАБОТКА РЕЗУЛЬТАТА ЗАДАНИЯ
		
RETURN ФР.АТОЛДТО10_ЗакрытьФРСПроверкойНаОшибки( "Проверка массива КМ", true );
