//Обработка сервера

_ОШИБКАВЗАПРОСЕ			= false;
ОтветОшибка				= "";
Ответ					= "";
ТокенАвторизации		= "";
ЗапрашиваемыеДанные		= "";
Соединение				= СОКЕТСОЕДИНИТЬ( __СОКЕТ );
Строка					= СОКЕТПОЛУЧИТЬ( Соединение, CHR( 13 ) + CHR( 10 ), "S" );

ДлинаДанных				= 0;
PostRequest				= LEFT( Строка, 4 ) == "POST";
GetRequest				= LEFT( Строка, 3 ) == "GET";
PutRequest				= LEFT( Строка, 3 ) == "PUT";
DeleteRequest			= LEFT( Строка, 6 ) == "DELETE";
OptionsRequest			= LEFT( Строка, 7 ) == "OPTIONS";
status_code				= 200;

ФайлЖурнала				= ФАЙЛОТКРЫТЬ( RESTAPI.ИМЯФАЙЛАЖУРНАЛА( "E:\", "itida_rest_api" ), 1, 1 );
ФАЙЛУСТАНОВИТЬУКАЗАТЕЛЬ( ФайлЖурнала, 0, 0, 2 );

IF ( OptionsRequest )
	ЗапрашиваемыеДанные = "";
ELSE
{
	ЗапрашиваемыеДанные		= ПЕРЕКОДИРОВАТЬ( ПОЛУЧИТЬСЛОВО( Строка, "/", " ", 1 ), "ANSI", "UTF-8"  );
	ФАЙЛЗАПИСАТЬ( ФайлЖурнала, CHR( 13 ) + CHR( 10 ) + "request_url = " + ПЕРЕКОДИРОВАТЬ( ЗапрашиваемыеДанные, "ANSI", "UTF-8"  ) + CHR( 13 ) + CHR( 10 ));
}

ФАЙЛЗАПИСАТЬ( ФайлЖурнала, CHR( 13 ) + CHR( 10 ) + "request: " );
ФАЙЛЗАПИСАТЬ( ФайлЖурнала, CHR( 13 ) + CHR( 10 ) + Строка );
WHILE ( !ПУСТО( Строка ) AND !OptionsRequest )
{
	Строка			= СОКЕТПОЛУЧИТЬ( Соединение, CHR( 13 ) + CHR( 10 ), "S" );
	IF ( LEFT( Строка, 16 ) == "Content-Length: " )
		ДлинаДанных	= VAL( ПОДСТРОКА( Строка, 16 ) );
	
	IF ( LEFT( Строка, 21 ) == "Authorization: Basic " )
		ТокенАвторизации = ALLTRIM( ПОДСТРОКА( Строка, 21 ) );
		
	ФАЙЛЗАПИСАТЬ( ФайлЖурнала, Строка );
}
ФАЙЛЗАПИСАТЬ( ФайлЖурнала, CHR( 13 ) + CHR( 10 ) + Строка );

ЗаголовокОтвета	= "HTTP/1.1 200 OK" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "status_code: $$status_code$$" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "reason: okhttp/4.9.0" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "Content-Type: application/json;charset=utf-8" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "Access-Control-Allow-Origin: *" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "Access-Control-Allow-Methods: POST, GET, OPTIONS, PUT, DELETE" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "Access-Control-Allow-Headers: Accept, Content-Type, Content-Length, Accept-Encoding, X-CSRF-Token, Authorization" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "Content-Length: $$CONTENTLEN$$" + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "ETag: " + УНИКАЛЬНОЕИМЯ( ) + CHR( 13 ) + CHR( 10 );
ЗаголовокОтвета += "Server: Jetty(8.1.0.RC0)" + CHR( 13 ) + CHR( 10 );

УспешнаяАвторизация = RESTAPI.APIПроверитьАвторизацию( ТокенАвторизации );

ПараметрыЗапроса = RESTAPI.APIРазобратьПараметрыЗапроса( ЗапрашиваемыеДанные );
УРЛЗапроса		 = ЗАМЕНИТЬ( ЗАМЕНИТЬ( ЗапрашиваемыеДанные, ПараметрыЗапроса, "" ), "?", "");

ФАЙЛЗАПИСАТЬ( ФайлЖурнала, "url = " + ПЕРЕКОДИРОВАТЬ( УРЛЗапроса, "ANSI", "UTF-8"  ) + CHR( 13 ) + CHR( 10 ));
ФАЙЛЗАПИСАТЬ( ФайлЖурнала, "params = " + ПЕРЕКОДИРОВАТЬ( ПараметрыЗапроса, "ANSI", "UTF-8"  ) + CHR( 13 ) + CHR( 10 ));

//обработка ошибок
IF ( !OptionsRequest )
{
	IF ( !УспешнаяАвторизация )
	{		
		_ОШИБКАВЗАПРОСЕ = true;
		
		Ответ			= "Неправильные логин или пароль";
		HTTPОтвет		= "HTTP/1.1 403 Forbidden";
		HTTPКодОтвета	= "403";
		HTTPТекстОтвета	= "Bad credentials";		
	}
	ELSE IF ( ПУСТО( ЗапрашиваемыеДанные ) )
	{
		_ОШИБКАВЗАПРОСЕ = true;
		
		Ответ			= "Ошибка в запросе";
		HTTPОтвет		= "HTTP/1.1 400 Bad Request";
		HTTPКодОтвета	= "400";
		HTTPТекстОтвета	= "Bad request";
	}
	ELSE IF ( !ВСПИСКЕ( УРЛЗапроса, "test", "warehouses", "wares" ) )
	{
		_ОШИБКАВЗАПРОСЕ = true;
		
		Ответ			= "Запрашиваемый ресурс не найден";
		HTTPОтвет		= "HTTP/1.1 404 Not Found";
		HTTPКодОтвета	= "404";
		HTTPТекстОтвета	= "Not found";
	}	 
}
IF ( _ОШИБКАВЗАПРОСЕ)
{
	ДанныеОтвета = ПЕРЕКОДИРОВАТЬ( "{ " + ДАННЫЕ_JSON("data", Ответ) + " }", "ANSI", "UTF-8"  );
	
	ЗаголовокОтвета = ЗАМЕНИТЬ( ЗаголовокОтвета, "$$CONTENTLEN$$", STR( LEN( ДанныеОтвета ) ) );
	ЗаголовокОтвета = ЗАМЕНИТЬ( ЗаголовокОтвета, "HTTP/1.1 200 OK", HTTPОтвет );
	ЗаголовокОтвета = ЗАМЕНИТЬ( ЗаголовокОтвета, "$$status_code$$", HTTPКодОтвета );
	ЗаголовокОтвета += "error: $$error$$" + CHR( 13 ) + CHR( 10 );
	ЗаголовокОтвета = ЗАМЕНИТЬ( ЗаголовокОтвета, "$$error$$", ПЕРЕКОДИРОВАТЬ( HTTPТекстОтвета, "ANSI", "UTF-8"  ) );
	
	ОтветОшибка 	= ЗаголовокОтвета + CHR( 13 ) + CHR( 10 ) + ДанныеОтвета;
	
	ФАЙЛЗАПИСАТЬ( ФайлЖурнала, CHR( 13 ) + CHR( 10 ) + "response: " );
	ФАЙЛЗАПИСАТЬ( ФайлЖурнала, ОтветОшибка );
	ФАЙЛЗАКРЫТЬ( ФайлЖурнала );
	СОКЕТПЕРЕДАТЬ( Соединение,  ОтветОшибка );
	ОЖИДАНИЕ( 1000 );
	СОКЕТЗАКРЫТЬ( Соединение );
	
	RETURN true;
}

ТЕЛОЗАПРОСА = "";
IF ( PostRequest AND ДлинаДанных > 0 )
{
	ТЕЛОЗАПРОСА				= СОКЕТПОЛУЧИТЬ( Соединение, CHR( 13 ) + CHR( 10 ), "S", ДлинаДанных );
	ФАЙЛЗАПИСАТЬ( ФайлЖурнала, ТЕЛОЗАПРОСА );
}

//разбираем запрос и возвращаем на него ответ
Ответ = RESTAPI.APIОбработатьЗапросИВернутьОтвет( УРЛЗапроса, ПараметрыЗапроса, ТЕЛОЗАПРОСА);

ЗаголовокОтвета = ЗАМЕНИТЬ( ЗаголовокОтвета, "$$CONTENTLEN$$", STR( LEN( Ответ ) ) );
ЗаголовокОтвета = ЗАМЕНИТЬ( ЗаголовокОтвета, "$$status_code$$", "200" );

ФАЙЛЗАПИСАТЬ( ФайлЖурнала, CHR( 13 ) + CHR( 10 ) + ЗаголовокОтвета );
ФАЙЛЗАПИСАТЬ( ФайлЖурнала, CHR( 13 ) + CHR( 10 ) + Ответ );

СОКЕТПЕРЕДАТЬ( Соединение, ЗаголовокОтвета + CHR( 13 ) + CHR( 10 ) + Ответ );
ОЖИДАНИЕ( 1000 );
СОКЕТЗАКРЫТЬ( Соединение );
ФАЙЛЗАКРЫТЬ( ФайлЖурнала );
RETURN true;
