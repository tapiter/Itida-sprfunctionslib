//Маркировка
//Значение маркировки может быть передано как строкой, так и объектом.
//Если передается строка, то её значение интерпретируется как base64-закодированное значение реквизита 1162.
//В этом случае пользователь должен сам составить значение реквизита, закодировать его в base64 и передать драйверу.
//Описание объектов представлено ниже. При передаче значения марки как объекта, драйвер самостоятельно, основываясь на переданных значениях, составляет реквизит 1162.
//Параметры:
//gtin (строка) - Идентификатор продукта GTIN
//serial (строка) -	furs - Серийный номер / medicines - Контрольный (идентификационный) знак (КиЗ) / tobacco - Код идентификации / shoes - Серийный номер
//type (строка) - тип маркировки
//					furs - меховые изделия 
//					medicines - лекарства 
//					tobacco - табачная продукция 
//					shoes - обувь
//Пример для мех. изделий:
/*
ТекстМаркировка = "
	""nomenclatureCode"":{
		""type"": ""furs"",
		""gtin"": ""98765432101234"",
		""serial": ""RU-430302-ABC1234567""
		}
	";	
//Произвольная маркировка
ТекстМаркировка = """nomenclatureCode"": ""MTIzNDEyMzQ1Njc4MTIzNDU2Nzg5MDEyMzQ1Njc4OTA=""";
*/
IF ( ТИП( "_ИСПОЛЬЗОВАТЬСТАРЫЙФОРМАТТЭГА1162" ) == "U" )
	_ИСПОЛЬЗОВАТЬСТАРЫЙФОРМАТТЭГА1162 = false; //Признак необходимости использовать старый формат тэга 1162 для чеков. По умолчанию равен false, т.е. используется новый формат
	
ТекстМаркировка 	= "";

IF ( ALLTRIM(КомандыЧека.ffd_version) == "1.2" )
{
	markingCode = ПЕРЕКОДИРОВАТЬ( ALLTRIM( ШКМарки ), "", "BASE64" );
	
	//если потерялся результат проверки, то заполняем стандартным результатом с неизвестным статусом и буквой М в чеке
	IF ( ПУСТО( РезультатПроверкиКМ ) )
		РезультатПроверкиКМ = "{""ecrStandAloneFlag"":false,""imcCheckFlag"":false,""imcCheckResult"":false,""imcEstimatedStatusCorrect"":false,""imcStatusInfo"":false}";
	
	JSONДанныеПроверкиТовара = """itemInfoCheckResult"": " + РезультатПроверкиКМ;
	JSONПланируемыйСтатусКМ = ЕСЛИ( КомандыЧека.operation == "Регистрация", "itemPieceSold", "itemPieceReturn" );
		
	ТекстМаркировка = ",
		""imcParams"":{
			""imcType"": ""auto"",
			""imc"": """ + markingCode + """,
			""itemEstimatedStatus"": """ + JSONПланируемыйСтатусКМ + """,
            ""imcModeProcessing"": 0,
			" + JSONДанныеПроверкиТовара + "
			}
			";
}
ELSE
{
	IF (_ИСПОЛЬЗОВАТЬСТАРЫЙФОРМАТТЭГА1162 == true)
	{
		IF ( VAL( КомандыЧека.marktype ) == 5 ) //табачная продукция
		{
			gtin	= SUBSTR( ШКМарки, 1, 14 );
			serial	= SUBSTR( ШКМарки, 15, 7 );
			ТекстМаркировка = ",
			""nomenclatureCode"":{
				""type"": ""tobacco"",
				""gtin"": """ + gtin + """,
				""serial"": """ + serial + """
				}
				";
		}
		ELSE IF ( VAL( КомандыЧека.marktype ) == 3 ) //лекарства
		{
			gtin	= SUBSTR( ШКМарки, 1, 14 );
			serial	= SUBSTR( ШКМарки, 15, 13 );
			ТекстМаркировка = ",
			""nomenclatureCode"":{
				""type"": ""medicines"",
				""gtin"": """ + gtin + """,
				""serial"": """ + serial + """
				}
				";
		}
		ELSE IF ( VAL( КомандыЧека.marktype ) == 1520 ) //обувь
		{
			gtin	= SUBSTR( ШКМарки, 3, 14 );
			serial	= SUBSTR( ШКМарки, 19, 13 );
			ТекстМаркировка = ",
			""nomenclatureCode"":{
				""type"": ""shoes"",
				""gtin"": """ + gtin + """,
				""serial"": """ + serial + """
				}
				";
		}
		ELSE IF ( VAL( КомандыЧека.marktype ) == 2 ) //меховые изделия
		{
			gtin	= SUBSTR( ШКМарки, 1, 14 );
			serial	= SUBSTR( ШКМарки, 15, 20 ); //??? под вопросом начальная позиция
			ТекстМаркировка = ",
			""nomenclatureCode"":{
				""type"": ""furs"",
				""gtin"": """ + gtin + """,
				""serial"": """ + serial + """
				}
				";
		}
	}
	ELSE
	{
		IF (TYPE ("_ККТПЕРЕДАВАТЬПОЛНЫЙКОДМАРКИРОВКИ") == "U")
			_ККТПЕРЕДАВАТЬПОЛНЫЙКОДМАРКИРОВКИ = false; //признак необходимости передавать весь код маркировки в составе реквизитов чека
		
		ШтрихкодМаркировкиДляЧека = ШКМарки;
		
		IF ( _ККТПЕРЕДАВАТЬПОЛНЫЙКОДМАРКИРОВКИ == false	)
		{
			ДлинаКодаМаркировки = 0;
			gtin = "";
			serial = "";
			ДлинаКодаМаркировки = ФР.ПолучитьДлиннуШтрихкодаМаркировки(ШКМарки, КомандыЧека.marktype, gtin, serial);
			
			IF ( ДлинаКодаМаркировки > 0 )
				ШтрихкодМаркировкиДляЧека = LEFT( ШКМарки, ДлинаКодаМаркировки );
		}
							
		markingCode = ПЕРЕКОДИРОВАТЬ( ALLTRIM( ШтрихкодМаркировкиДляЧека ), "", "BASE64" );
		
		ТекстМаркировка = ",
			""markingCode"":{
				""type"": ""other"",
				""mark"": """ + markingCode + """
				}
				";
		
		//ТекстМаркировка = "," + CHR(13) + """nomenclatureCode"": """ + markingCode + """";
	}
}
	
RETURN ТекстМаркировка;
