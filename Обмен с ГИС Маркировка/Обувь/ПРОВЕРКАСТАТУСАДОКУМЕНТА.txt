
ИМЯПОЛЯ					= ЕСЛИ( ПУСТО( ИМЯПОЛЯ ), "guid", ИМЯПОЛЯ );
СЕРТИФИКАТ				= ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'MARK_CERTIFICATE" + ПРЕДПРИЯТИЕ + "'" );
ТЕСТОВЫЙКОНТУР			= VAL( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'MARK_APITEST" + ПРЕДПРИЯТИЕ + "'" ) ) != 0 ;

// Отправляем запрос документа в МАРКИРОВКУ
// Запрашиваем статус документа
Документ			= МАРКИРОВКА.ЗАПРОСДОКУМЕНТА( ПРЕДПРИЯТИЕ, СЕРТИФИКАТ, ТЕСТОВЫЙКОНТУР, ИДДОКУМЕНТА );
IF ( ПУСТО( Документ ) ) RETURN false;

ЗАГРУЗИТЬJSON( "Документ", Документ );
ТипДокумента		= ПРОПИСНЫЕ( СЖАТЬПРОБЕЛЫ( ЗНАЧЕНИЕПОЛЯ( "Документ", "type", "" ) ) );
ИмяТаблицы			= ЕСЛИ( ЛЕВСИМВ( ТипДокумента, 7 ) == "LP_SHIP", "mark_out",
					  ЕСЛИ( ЛЕВСИМВ( ТипДокумента, 7 ) == "LK_KM_C", "mark_writeoff",
					  ЕСЛИ( ЛЕВСИМВ( ТипДокумента, 7 ) == "LK_APPL", "mark_writeoff",
					  ЕСЛИ( ЛЕВСИМВ( ТипДокумента, 7 ) == "LK_REMA", "mark_remark",
					  ЕСЛИ( ЛЕВСИМВ( ТипДокумента, 7 ) == "LP_INTR", "mark_stock",
					  ЕСЛИ( ЛЕВСИМВ( ТипДокумента, 7 ) == "LP_ACCE", "mark_in",
					  ЕСЛИ( ТипДокумента == "LK_GTIN_RECEIPT", "mark_reciept", 
					  ЕСЛИ( ТипДокумента == "LK_RECEIPT", "mark_reciept", "" ) ) ) ) ) ) ) );
IF ( ПУСТО( ИмяТаблицы ) ) 
{
	УДАЛИТЬКОНТЕКСТ( "Документ" );
	RETURN false;
}
	
СтатусДокумента		= ПРОПИСНЫЕ( СЖАТЬПРОБЕЛЫ( ЗНАЧЕНИЕПОЛЯ( "Документ", "status", "" ) ) );
// Если документ был принят без ошибок, то ставим статус 1.
IF ( СтатусДокумента == "CHECKED_OK" )
{
	Статус			= ЕСЛИ( ИмяТаблицы == "mark_out", 1, 
					  ЕСЛИ( ИмяТаблицы == "mark_writeoff", 2,
					  ЕСЛИ( ИмяТаблицы == "mark_remark", 2,
					  ЕСЛИ( ИмяТаблицы == "mark_stock", 3, 
					  ЕСЛИ( ИмяТаблицы == "mark_in", 2,
					  ЕСЛИ( ИмяТаблицы == "mark_reciept", 2, 0 ) ) ) ) ) );
	ЗАПРОС( "UPDATE " + ИмяТаблицы + " SET status = " + Статус + ", reply= 'нет ошибок' WHERE " + ИМЯПОЛЯ + " = '" + ИДДОКУМЕНТА + "'" );
}
ELSE IF ( СтатусДокумента == "IN_PROGRESS" )
{
	Статус			= ЕСЛИ( ИмяТаблицы == "mark_out", 1, 
					  ЕСЛИ( ИмяТаблицы == "mark_writeoff", 1, 
					  ЕСЛИ( ИмяТаблицы == "mark_remark", 1, 
					  ЕСЛИ( ИмяТаблицы == "mark_stock", 2, 
					  ЕСЛИ( ИмяТаблицы == "mark_in", 1, 
					  ЕСЛИ( ИмяТаблицы == "mark_reciept", 1, 0 ) ) ) ) ) );
	ЗАПРОС( "UPDATE " + ИмяТаблицы + " SET status = " + Статус + ", reply= 'Отправлен в ГИС МТ. Ожидается обработка.' WHERE " + ИМЯПОЛЯ + " = '" + ИДДОКУМЕНТА + "'" );
}
ELSE IF ( СтатусДокумента == "CHECKED_NOT_OK" OR СтатусДокумента == "PROCESSING_ERROR" )
{
	Статус			= ЕСЛИ( ИмяТаблицы == "mark_out", 4,
					  ЕСЛИ( ИмяТаблицы == "mark_writeoff", 3,
					  ЕСЛИ( ИмяТаблицы == "mark_remark", 3,
					  ЕСЛИ( ИмяТаблицы == "mark_stock", 4,
					  ЕСЛИ( ИмяТаблицы == "mark_in", 3,
					  ЕСЛИ( ИмяТаблицы == "mark_reciept", 3, 0 ) ) ) ) ) );
	// Иначе, выводим сообщение об ошибке и статус 2
	ЗАГРУЗИТЬJSON( "Ошибка", ЗНАЧЕНИЕПОЛЯ( "Документ", "errors", "" ), "error_message" );
	ТекстОшибки		= ПЕРЕКОДИРОВАТЬ( ЗНАЧЕНИЕПОЛЯ( "Ошибка", "error_message", "" ), "UTF-8", "ANSI" );
	ЗАПРОС( "UPDATE " + ИмяТаблицы + " SET status = " + Статус + ", reply= '" + ЛЕВСИМВ( STDF( ТекстОшибки ), 250 ) + "' WHERE " + ИМЯПОЛЯ + " = '" + ИДДОКУМЕНТА + "'" );
}
ELSE IF ( СтатусДокумента == "CANCELLED" )
{
	Статус			= 5;
	ЗАПРОС( "UPDATE " + ИмяТаблицы + " SET status = " + Статус + ", reply= 'Отгрузка отменена'  WHERE " + ИМЯПОЛЯ + " = '" + ИДДОКУМЕНТА + "'" );
}
ELSE IF ( СтатусДокумента == "ACCEPTED" )
{
	Статус			= 2;
	ЗАПРОС( "UPDATE " + ИмяТаблицы + " SET status = " + Статус + ", reply= 'Отгрузка принята'  WHERE " + ИМЯПОЛЯ + " = '" + ИДДОКУМЕНТА + "'" );
}
ELSE IF ( СтатусДокумента == "WAIT_ACCEPTANCE" || СтатусДокумента == "WAIT_PARTICIPANT_REGISTRATION" )
{
	Статус			= 1;
	ЗАПРОС( "UPDATE " + ИмяТаблицы + " SET status = " + Статус + ", reply= 'Ожидание приемки'  WHERE " + ИМЯПОЛЯ + " = '" + ИДДОКУМЕНТА + "'" );
}
УДАЛИТЬКОНТЕКСТ( "Документ" );
RETURN true;
