IF ( ПУСТО( ИДЕНТИФИКАТОРЧЕКА ) )
{
	СООБЩЕНИЕ("Не определен идентификатор чека. " + CHR(13) + CHR(10) + "Отравка чека в Locards проведена не будет.", "Locards - отправка чека");
	RETURN false;
}

IF  ( ПУСТО( НОМЕРКАРТЫ ) ) 
{
	//СООБЩЕНИЕ("Не определен номер карты. " + CHR(13) + CHR(10) + "Отравка чека в Locards проведена не будет.", "Locards - отправка чека");
	RETURN false;
}

Локардс_Токен = RESTAPI.LOCARDS_TOKEN( НОМЕРКАРТЫ );
IF ( ПУСТО(Локардс_Токен) )
{
	СООБЩЕНИЕ("Не определен токен LOCARDS. " + CHR(13) + CHR(10) + "Отравка чека в Locards проведена не будет.", "Locards - отправка чека");
	RETURN false;
}

//выберем данные шапки документа
ДОБАВИТЬКОНТЕКСТ( "SELECT rid, date, firm, cur, sklad, kskod, client, partner, cardnumber, checktype, 
				subtotal, bonus, chequediscount, chequediscount_prc, telemail, author, shiftnumber, chequenumber, comment
				FROM chequelist WHERE identity_column = '" + ИДЕНТИФИКАТОРЧЕКА + "'", "ДанныеДокумента" );
ВЫБРАТЬКОНТЕКСТ("ДанныеДокумента");

ЧЕКИДЕНТИФИКАТОР = ДанныеДокумента.rid;
ДОКУМЕНТ_СУММАИТОГ = ДанныеДокумента.subtotal;
ДОКУМЕНТ_СУММАБОНУС = ДанныеДокумента.bonus;
ДОКУМЕНТ_СУММАСКИДКИ = ДанныеДокумента.chequediscount;
ДОКУМЕНТ_СУММАСКИДКИПРОЦЕНТ = ДанныеДокумента.chequediscount_prc;
ДОКУМЕНТ_ТЕЛЕФОНПОЧТА = ДанныеДокумента.telemail;
ДОКУМЕНТ_АВТОР = ДанныеДокумента.author;
ДОКУМЕНТ_ДАТА = ДанныеДокумента.date;
ДОКУМЕНТ_КОММЕНТАРИЙ = ДанныеДокумента.comment;
ДОКУМЕНТ_ФИРМА = ДанныеДокумента.firm;
ДОКУМЕНТ_СКЛАД = ДанныеДокумента.sklad;
ДОКУМЕНТ_ВЛАДЕЛЕЦКАРТЫ = ДанныеДокумента.client;
ДОКУМЕНТ_КОНТРАГЕНТ = ДанныеДокумента.partner;
ДОКУМЕНТ_КАРТА = ДанныеДокумента.cardnumber;
ДОКУМЕНТ_ТИПЧЕКА = ДанныеДокумента.checktype;
ДОКУМЕНТ_НОМЕРЧЕКА = ДанныеДокумента.chequenumber;

//удаляем контекст
УДАЛИТЬКОНТЕКСТ("ДанныеДокумента");

СуммаДляРасчетаБонуса = 0.00;
ДОБАВИТЬКОНТЕКСТ("SELECT chequespec.ic, chequespec.nn, chequespec.s_code, chequespec.nnname, chequespec.kolp, chequespec.cena,
					chequespec.summa, chequespec.cena_sale, chequespec.summa_sale, chequespec.cena_wd, chequespec.summa_wd, chequespec.barcode,
					chequespec.ed, chequespec.koef_e, chequespec.koef_c, sprres.f_nessassortment 
				FROM chequespec 
				inner join sprres on chequespec.nn = sprres.code 
				WHERE ic = '" + ИДЕНТИФИКАТОРЧЕКА + "' AND sprres.f_nessassortment = 0", "ПозицииЧека" );
ВЫБРАТЬКОНТЕКСТ( "ПозицииЧека" );
WHILE ( !КОНЕЦКОНТЕКСТА( "ПозицииЧека" ) )
{
	СуммаДляРасчетаБонуса += ПозицииЧека.summa_wd;	
		
	ПРОПУСТИТЬ( 1, "ПозицииЧека" );
}

ТипЧекаПечать	= "ПРОДАЖА";

IF ( VAL(ДОКУМЕНТ_ТИПЧЕКА) == 0 )
	ТипЧекаПечать	= "ПРОДАЖА";
ELSE IF ( VAL(ДОКУМЕНТ_ТИПЧЕКА) == 1 )
	ТипЧекаПечать	= "ВОЗВРАТ";
ELSE IF ( VAL(ДОКУМЕНТ_ТИПЧЕКА) == 2 )
	ТипЧекаПечать	= "РАСХОД";
ELSE IF ( VAL(ДОКУМЕНТ_ТИПЧЕКА) == 3 )
	ТипЧекаПечать	= "ВОЗВРАТ РАСХОДА";


СУММАСПИСЫВАЕМЫХБОНУСОВ = ЕСЛИ( ПУСТО( СУММАБАЛЛОВ ), ДОКУМЕНТ_СУММАБОНУС, СУММАБАЛЛОВ );

ТекстЧека = "";
ТекстЧека += "{";
ТекстЧека += """amount"": " + STR( СуммаДляРасчетаБонуса + СУММАСПИСЫВАЕМЫХБОНУСОВ, 10, 2) + ",";
ТекстЧека += """bonusesWriteOff"": " + STR( СУММАСПИСЫВАЕМЫХБОНУСОВ, 10, 2 ) + ",";
ТекстЧека += """otherDiscountsAmount"": 0" + ",";
ТекстЧека += """externalId"": """ + ИДЕНТИФИКАТОРЧЕКА + """,";
ТекстЧека += """cardNumber"": """ + STDF( НОМЕРКАРТЫ ) + """,";
ТекстЧека += """salePointId"": 1" + ",";
ТекстЧека += """discount"": 0" + ",";

ТекстЧека += """products"": [";

//позиции чека
ПЕРЕЙТИВНАЧАЛО( "ПозицииЧека" );
ВЫБРАТЬКОНТЕКСТ( "ПозицииЧека" );
WHILE ( !КОНЕЦКОНТЕКСТА( "ПозицииЧека" ) )
{
	ПОЗИЦИЯ_КОД = ЕСЛИ( !ПУСТО( ПозицииЧека.nn ), ПозицииЧека.nn, ПозицииЧека.s_code);
	ПОЗИЦИЯ_НАИМЕНОВАНИЕ = ПозицииЧека.nnname; 
	ПОЗИЦИЯ_КОЛИЧЕСТВО = ПозицииЧека.kolp;
	ПОЗИЦИЯ_ЦЕНАСОСКИДКОЙ = ПозицииЧека.cena_wd;
	ПОЗИЦИЯ_СУММАСОСКИДКОЙ = ПозицииЧека.summa_wd;
	
	ТекстЧека += ЕСЛИ( ПРАВСИМВ( ТекстЧека, 1 ) == "}", ",", "" ) + "{";
	
	ТекстЧека += ДАННЫЕ_JSON("name", ПОЗИЦИЯ_НАИМЕНОВАНИЕ ) + ",";
	ТекстЧека += """id"": """ + ПОЗИЦИЯ_КОД + """,";
	ТекстЧека += """count"": " + STR( ПОЗИЦИЯ_КОЛИЧЕСТВО, 10, 3) + ",";
	ТекстЧека += """price"": " + STR( ПОЗИЦИЯ_ЦЕНАСОСКИДКОЙ, 10, 2 ) + ",";
	ТекстЧека += """summ"": " + STR( ПОЗИЦИЯ_СУММАСОСКИДКОЙ, 10, 2 );
	
	ТекстЧека += "}";
	
	ПРОПУСТИТЬ( 1, "ПозицииЧека" );
}
УДАЛИТЬКОНТЕКСТ( "ПозицииЧека" );
	
ТекстЧека += "],";

ТекстЧека += """commentOnOperation"": """ + ТипЧекаПечать + " по кассовому чеку № " + ДОКУМЕНТ_НОМЕРЧЕКА + """";
ТекстЧека += "}";

УспешноеВыполнение = false;
Локардс_АдресСервера = "https://api.lo.cards";

АдресРесурса = "/v1/crm/sale";

Заголовки[0] = "Authorization: Bearer " + ALLTRIM( Локардс_Токен );	
Заголовки[1] = "Content-Type: application/json; charset=utf-8";	
	
ОТВЕТ_локардс = RESTAPI.LOCARDS_POSTЗАПРОС( Локардс_АдресСервера, АдресРесурса, ТекстЧека, "Заголовки" );

IF ( !ПУСТО( ОТВЕТ_локардс) AND ОТВЕТ_локардс != false )
	УспешноеВыполнение = ПОЛЕ_JSON( ОТВЕТ_локардс, "success", false);
	

RETURN УспешноеВыполнение == true OR УспешноеВыполнение == "true";
