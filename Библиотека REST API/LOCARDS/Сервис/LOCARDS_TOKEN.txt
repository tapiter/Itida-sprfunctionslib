IF ( ПУСТО( НОМЕРКАРТЫ ) ) RETURN ПЕРЕМЕННАЯ("_LOCARDS_TOKEN", "" );

Токен = "";
//определим код бонусного счетчика, привязанного к карте
КОДСЧЕТЧИКАБОНУСОВ = ЗАПРОС("SELECT bonus FROM sprmcard WHERE cardn = '" + НОМЕРКАРТЫ + "'");

//если не привязан счетчик к карте, то далее не будем ничего определять и вернем токен из константы _LOCARDS_TOKEN
IF ( ПУСТО( КОДСЧЕТЧИКАБОНУСОВ ) ) RETURN ПЕРЕМЕННАЯ("_LOCARDS_TOKEN", "" );

//выберем данные по счетчику с типом бонуса LOCARDS и не пустым токеном в доп параметрах
ДОБАВИТЬКОНТЕКСТ( "SELECT code, name, dbo.fn_getchar_ex('SPR', 'SA7', 'LOCARDS_токен', code, '', '', '' ) AS token
					FROM sprbonus 
					WHERE code = '" + КОДСЧЕТЧИКАБОНУСОВ + "'
					AND dbo.fn_getchar_ex('SPR', 'SA7', 'LOCARDS_токен', code, '', '', '' ) IS NOT NULL", "ТокеныЛокардс");
					
//если нет токена в доп параметрах счетчика бонусов LOCARDS, то вернем токен из константы _LOCARDS_TOKEN
IF ( КОЛИЧЕСТВОСТРОК( "ТокеныЛокардс" ) == 0 ) RETURN ПЕРЕМЕННАЯ("_LOCARDS_TOKEN", "" );

ВЫБРАТЬКОНТЕКСТ( "ТокеныЛокардс" );
//если есть токен в доп параметрах, то берем первый и прерываем перебор контекста
WHILE ( !КОНЕЦКОНТЕКСТА( "ТокеныЛокардс" ) )
{
	Токен = ТокеныЛокардс.token;
	BREAK;
	ПРОПУСТИТЬ( 1, "ТокеныЛокардс");
}
УДАЛИТЬКОНТЕКСТ( "ТокеныЛокардс" );

//если не определили токен, то вернем токен из константы _LOCARDS_TOKEN
IF ( ПУСТО( Токен ) ) RETURN ПЕРЕМЕННАЯ("_LOCARDS_TOKEN", "" );

RETURN Токен;
