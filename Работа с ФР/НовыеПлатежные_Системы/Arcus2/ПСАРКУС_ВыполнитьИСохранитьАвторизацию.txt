ТекстЧека = "";
ЗаголовокЧека = "";
ПозицииЧека = "";
БанковскиеПозицииЧека = "";
//ТИПОПЕРАЦИИ, СУММАОПЕРАЦИИ, НОМЕРССЫЛКИДЛЯВОЗВРАТА, КОДВАЛЮТЫ 

IF ( !ФР.ПСАРКУС_Установлен() ) RETURN false;

//если ВОЗВРАТ и не передан номер ссылки
IF ( ПУСТО( НОМЕРССЫЛКИДЛЯВОЗВРАТА ) AND ( ВСПИСКЕ( КОДОПЕРАЦИИАРКУС, 3, 4 ) ) )
{
	// Запрашиваем значение реквизита Ссылочный номер
	ОТПРАВИТЬСООБЩЕНИЕ( _ГЛАВНОЕОКНОПРИЛОЖЕНИЯ, _СООБЩЕНИЕВЫПОЛНИТЬКОМАНДУ, "ЗАПРОСПАРАМЕТРОВ", "'ССЫЛОЧНЫЙНОМЕР'" );
	IF ( !_РЕЗУЛЬТАТВВОДАПАРАМЕТРОВ ) RETURN false;
	НОМЕРССЫЛКИДЛЯВОЗВРАТА = ССЫЛОЧНЫЙНОМЕР;
}

IF ( !ФР.ПСАРКУС_ВыполнитьКоманду( КОДОПЕРАЦИИАРКУС, СУММАОПЕРАЦИИ, НОМЕРССЫЛКИДЛЯВОЗВРАТА, КОДВАЛЮТЫ ) ) RETURN false;

ОтветПС = ФР.ПСАРКУС_ПрочитатьОтветПС();
IF ( ОтветПС <> "000" )
{
	СООБЩЕНИЕ( "Ошибка платежной системы: " + ОтветПС + "." + CHR(13) + CHR(10) +
	ФР.ПСАРКУС_ПолучитьСлип( ), ФР.ПСИМЯОБОРУДОВАНИЯ() );
	RETURN false;
}
ELSE
{
	ПозицииЧека = "";
	
	/*
	IF ( TYPE("КОДОБОРУДОВАНИЯ") == "U" )
		КОДОБОРУДОВАНИЯ = ФРКОДОБОРУДОВАНИЯ;
	*/
	
	//получаем слип-чек и добавляем в чек
	СлипЧек = ФР.ПСАРКУС_ПолучитьСлип();
	
	//получить номер ссылки из слипа
	НОМЕРССЫЛКИ = ФР.ПСАРКУС_ПолучитьНомерСсылкиИзСлипа( СлипЧек );
		
	КОЛИЧЕСТВОСЛИПОВ = ЗАПРОС("SELECT slipcount FROM sprequipment WHERE code = '" + КОДОБОРУДОВАНИЯ + "'");

	try
	{
		ЗАПРОС( "INSERT INTO paycardtrans ( equipment, owner, TransType, AuthCode, OperationType, Sum, TransDate, TransTime, TerminalID, ReferenceNumber, slip, slipcount, fr_code )
				VALUES ( '"	+ КОДОБОРУДОВАНИЯ + "', '" 
							+ _UNCONFIRMEDID + "', '" 
							+ ТипЧека + "', '"
							+ "" + "', " 							 
							+ КодОперацииАркус + ", " 
							+ VAL( СУММАОПЕРАЦИИ ) / 100 + ", '" 
							+ ДАТА() + "', '" 
							+ ДАТАВРЕМЯ() + "', '" 
							+ "" + "', '" 
							+ НОМЕРССЫЛКИ + "', '" 
							+ STDF( СлипЧек ) + "', '"
							+ КОЛИЧЕСТВОСЛИПОВ + "', '" 
							+ ФРКОДОБОРУДОВАНИЯ + 
							"' )" );
	}
	catch()
	{
		СООБЩЕНИЕ("Ошибка записи данных сверки итогов в базу", ФР.ПСИМЯОБОРУДОВАНИЯ());
	}
	
	//печатаем сверку
	IF ( Сервис.РМККоманда( "ОБОРУДОВАНИЕ", "ФР" ) )
	{
		IF ( ATC(_ОБОРУДОВАНИЕ, ФРКОДОБОРУДОВАНИЯ ) > 0 )
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ФРКОДОБОРУДОВАНИЯ;
		ELSE
			КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ = ЛЕВСИМВ( _ОБОРУДОВАНИЕ, 3 );
		
		//СООБЩЕНИЕ("Выполняем команду ФР с кодом " + КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ, ФР.ПСИМЯОБОРУДОВАНИЯ() );
		ТипОтчета = -1;		
		РезультатПечатиСлипа = Сервис.РМККоманда( "ВЫПОЛНИТЬКОМАНДУПРОФИЛЯ", КОДОБОРУДОВАНИЯДЛЯПЕЧАТИ + "|116|ЭтоБанковскийСлип=true" );		
	}
}

RETURN true;
