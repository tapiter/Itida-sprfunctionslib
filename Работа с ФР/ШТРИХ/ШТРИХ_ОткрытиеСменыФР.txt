// Открытие смены ФР

// Параметры - 
// Заголовок строка, имя оператора открывающего смену
// FROperatorProfile число, профиль из карточки сотрудника

IF ( !ФР.ШТРИХ_ОткрытьФР( КОДОБОРУДОВАНИЯ, "Открытие смены" ) ) RETURN false;

//Проверим возраст буфера чеков
ФР.ШТРИХ_ПроверкаВозрастаБуфера( false );

driverKKM.Password		= FROperatorProfile;

//получим номер ККТ
driverKKM.ReadSerialNumber();
SerialNumber = driverKKM.SerialNumber;
IF ( !ПУСТО( SerialNumber ) )
{
	ЗАПРОС("DELETE FROM param_ex WHERE param = 'FR_SERIAL" + КОДОБОРУДОВАНИЯ + "'");		
	ЗАПРОС("INSERT INTO param_ex (param, value) VALUES ('FR_SERIAL" + КОДОБОРУДОВАНИЯ + "', '" + SerialNumber + "')");
}

driverKKM.FNGetCurrentSessionParams(); //получаем параметры смены
IF ( driverKKM.FNSessionState == 0 )
{	
	//контроль даты и времени в ККМ - начало
	IF ( _КОНТРОЛИРОВАТЬРАСХОЖДЕНИЕДАТЫВРЕМЕНИ )
	{
		IF ( !ФР.ШТРИХ_ПроверкаДатыККМ( ) ) RETURN false;
	}
	
	//теперь открываем смену
	ТекстВопроса 			= "В ККМ """ + ФР.ИМЯОБОРУДОВАНИЯ() + """ не открыта смена." + CHR( 13 ) + "Произвести открытие смены в ККМ?";
	КодОтвета 				= СООБЩЕНИЕ( ТекстВопроса, "Открытие смены", 4 );
	IF ( КодОтвета == 7 ) //если нажали "Нет"
	{
		ФР.ШТРИХ_ЗакрытьФРСПроверкойНаОшибки( КОДОБОРУДОВАНИЯ, "Открытие смены" );
		RETURN false;
	}
}
ELSE
{
	СООБЩЕНИЕ("Смена открыта в ККМ", ФР.ИМЯОБОРУДОВАНИЯ());
	RETURN true;
}

//открываем смену
driverKKM.OpenSession();

ФР.ШТРИХ_ОтрезатьЧек();

IF ( !ФР.ШТРИХ_ЗакрытьФРСПроверкойНаОшибки( КОДОБОРУДОВАНИЯ, "Открытие смены" ) )
	RETURN false;

RETURN true;
