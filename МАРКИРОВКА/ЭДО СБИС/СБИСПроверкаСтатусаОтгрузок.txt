
ДАТАЗАГРУЗКИ			= CTOD( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'MARK_EDIDOWNLOADDATE" + ПРЕДПРИЯТИЕ + "'" ) );
ТОЛЬКОМАРКИРОВКА		= VAL( ЗАПРОС( "SELECT value FROM param_ex WHERE param= 'MARK_EDIMARKING" + ПРЕДПРИЯТИЕ + "'" ) ) != 0;
IF ( РАЗНИЦАДАТ( ДАТАЗАГРУЗКИ, ДАТА( ), "day" ) > 30 )
	ДАТАЗАГРУЗКИ		= ДОБАВИТЬДНИ( ДАТА( ), -30 );

СБИСТОКЕН				= Маркировка.СБИСАвторизация( ПРЕДПРИЯТИЕ );
IF ( ПУСТО( СБИСТОКЕН ) ) RETURN false;

АдресСервера 			= Маркировка.СБИСАдресСервера( false );;
Заголовки[ 0 ]			= "Content-Type: application/json-rpc;charset=utf-8";
Заголовки[ 1 ]			= "X-SBISSessionID: " + СБИСТОКЕН;

ИДСобытия				= "";
НоваяРедакция			= "";
try
{
	ТекстОшибки			= "Сервер " + АдресСервера + CHR( 13 ) + "вернул сообщение об ошибке: " + CHR( 13 );
	Соединение 			= HTTPCONNECT( АдресСервера, "", true, Маркировка.ФАЙЛЖУРНАЛА( ) );

	Продолжать			= true;
	ВсегоДокументов		= 0;
	ПОКА ( Продолжать )
	{
		IF ( !ПУСТО( ИДСобытия ) )
			ТекстЗапроса	= ПЕРЕКОДИРОВАТЬ( "{""jsonrpc"": ""2.0"",""method"": ""СБИС.СписокИзменений"",""params"": {""Фильтр"": {""ИдентификаторСобытия"": """ + ИДСобытия + """,""ПолныйСертификатЭП"": ""Нет""}},""id"": 0 }", "ANSI", "UTF-8" );
		ELSE
			ТекстЗапроса	= ПЕРЕКОДИРОВАТЬ( "{""jsonrpc"": ""2.0"",""method"": ""СБИС.СписокИзменений"",""params"": {""Фильтр"": {""ДатаВремяС"": """ + TTOC( ДАТАЗАГРУЗКИ ) + """,""ПолныйСертификатЭП"": ""Нет""}},""id"": 0 }", "ANSI", "UTF-8" );
			
		Ответ				= HTTPPOST( Соединение, "service/?srv=1", ТекстЗапроса, "Заголовки" );
		IF ( !МАРКИРОВКА.СБИСПРОВЕРКАНАОШИБКИ( @Ответ ) ) THROW ( Ответ );
		
		ЗАГРУЗИТЬJSON( "Результат", ПЕРЕКОДИРОВАТЬ( ПОЛЕ_JSON( Ответ, "result", "" ), "UTF-8", "ANSI" ), "Результат" );
		ЗАГРУЗИТЬJSON( "СписокДокументов", ЗНАЧЕНИЕПОЛЯ( "Результат", "Документ", "" ), "Текст" );
				
		ВсегоДокументов		+= КОЛИЧЕСТВОСТРОК( "СписокДокументов" );
		ПЕРЕЙТИВНАЧАЛО( "СписокДокументов" );
		ПОКА( !КОНЕЦКОНТЕКСТА( "СписокДокументов" ) )
		{
			ЗАГРУЗИТЬJSON( "Документ", ЗНАЧЕНИЕПОЛЯ( "СписокДокументов", "Текст", "" ) );
			ИДДокумента		= ЗНАЧЕНИЕПОЛЯ( "Документ", "Идентификатор", "" );
			
			// Необходимо пройти все события, чтобы найти ИД последнего
			ЗАГРУЗИТЬJSON( "События", ЗНАЧЕНИЕПОЛЯ( "Документ", "Событие", "" ), "Текст" );
			ПЕРЕЙТИВНАЧАЛО( "События" );
			ПОКА( !КОНЕЦКОНТЕКСТА( "События" ) )
			{
				ИДСобытия	= ПОЛЕ_JSON( ЗНАЧЕНИЕПОЛЯ( "События", "Текст", "" ), "Идентификатор", "" );
				ПРОПУСТИТЬ( 1, "События" );
			}
			УДАЛИТЬКОНТЕКСТ( "События" );
			
			Статус			= VAL( ПОЛЕ_JSON( ЗНАЧЕНИЕПОЛЯ( "Документ", "Состояние", "" ), "Код", "" ) );
			СтатусДокумента	= ЕСЛИ( Статус <= 4, 1, ЕСЛИ( Статус == 6, 4, ЕСЛИ( Статус == 7, 2, ЕСЛИ( Статус == 9, 3, 5 ) ) ) );
			// Если все прошло без ошибок, то ставим статус отправки
			ЗАПРОС( "IF EXISTS( SELECT * FROM mark_out WHERE guid= '" + STDF( ИДДокумента ) + "' ) 
					 UPDATE mark_out SET status = " + СтатусДокумента + " WHERE guid= '" + STDF( ИДДокумента ) + "'" );
			
			ПРОПУСТИТЬ( 1, "СписокДокументов" );
		}
		УДАЛИТЬКОНТЕКСТ( "СписокДокументов" );

		Продолжать			= ПОЛЕ_JSON( ЗНАЧЕНИЕПОЛЯ( "Результат", "Навигация", "" ), "ЕстьЕще", "Нет" ) == "Да" && !ПУСТО( ИДСобытия );
		УДАЛИТЬКОНТЕКСТ( "Результат" );

		СИСТЕМНОЕСООБЩЕНИЕ( "Найдено " + STR( ВсегоДокументов ) + " записей журнала документов." );
	}	
	СИСТЕМНОЕСООБЩЕНИЕ( );
}
catch ( ТекстСообщения )
{
	СИСТЕМНОЕСООБЩЕНИЕ( );
	ИНДИКАТОР( );
	HTTPCLOSE( Соединение );
	СООБЩЕНИЕ( ТекстСообщения );
	RETURN false;
}
ИНДИКАТОР( );
HTTPCLOSE( Соединение );

RETURN true;
